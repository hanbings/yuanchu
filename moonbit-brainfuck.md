# 用 MoonBit 写了个带有 JIT 的 Brainfuck 解释器

## Brainfuck 语言

## 最小解释器

识别 BF 源代码，并按照代码进行解释执行。

> Moonbit 语言因为自身的特殊性，对不同的 `target` 需要独立实现 `stdin` 和 `stdout` 等宿主环境相关的调用；
> 在本文中，会尽可能的使用 Moonbit 语言编写，如果遇到实现过于困难的部分将会通过 Rust 实现，
> 并以动态链接库的方式暴露 `FFI` 接口供以 Moonbit 调用，因此本文会适当补充 `FFI` 相关的内容。

## 分层 —— 先解释再执行

原先的解释器总是读取一个字符立即在虚拟机中执行一个指令，虽然这样的解释器简短，但是也为我们在后续添加非标准语法和优化带来了阻碍，因此需要对解释器进行分层。在 `lexer` 层 `token` 转为 `parser` 层的 `ast` 再对 `ast` 进行优化再执行。

## 添加非标准语法

添加 `!` 和 `#` 语法，`!` 是调试语法，当执行到 `!` 时将有值的 `cell` 进行输出，并等待用户输入进行下一步操作，`#` 是注释语法，不参与到解释和执行中，在 `lexer` 期间就可以去除。

### 实现 # 注释

### 实现 ! 断点

## JIT 超级加速！

通过将原始的 BF 语言操作码转换为机器码并执行，从此彻底脱离虚拟机执行，以达到最高效率。

### x86_64 指令格式

### 指针位移与修改值

### 输入 / 输出

## 进一步优化

通过识别和合并相同的操作进行优化。例如 `>>>>>` 5 次右移合并为将指针直接右移 5 位，`[-]` 使用循环进行 `cell` 清零变为直接设置为 0 。

### 操作的合并

### 识别常见指令

### 修改机器码生成器，添加优化到 JIT 中

## 交互式环境

### Moonbit 中的 main

### step 实现